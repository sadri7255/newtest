<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم هوشمند مدیریت آب بها</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Jalali Date Picker -->
    <link rel="stylesheet" href="https://unpkg.com/jalali-datepicker/dist/jalali-datepicker.min.css">
    <script src="https://unpkg.com/jalali-datepicker/dist/jalali-datepicker.min.js"></script>

    <!-- Chart.js for potential future graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PDF & Excel Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Custom Styles & Font -->
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .jalali-datepicker-container { z-index: 10000 !important; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, transform 0.5s;
            transform: translateY(20px);
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="bg-white rounded-xl shadow-sm p-6 mb-6 flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-cyan-600">سیستم هوشمند مدیریت آب بها</h1>
                <div id="period-info" class="text-gray-500 mt-2">
                    <p id="current-period-title" class="font-semibold text-lg">هیچ دوره‌ای انتخاب نشده است</p>
                    <p id="current-period-dates" class="text-sm"></p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                <button id="manage-periods-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    <span>مدیریت دوره‌ها</span>
                </button>
                <button id="settings-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>
                    <span>تنظیمات تعرفه</span>
                </button>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-4">
                <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></div>
                <div>
                    <h3 class="text-gray-500 text-sm">مجموع مصرف کل</h3>
                    <p id="total-consumption" class="text-2xl font-bold text-blue-700">0 m³</p>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-4">
                <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg></div>
                <div>
                    <h3 class="text-gray-500 text-sm">مجموع هزینه کل</h3>
                    <p id="total-calculated-cost" class="text-2xl font-bold text-green-700">0 تومان</p>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-4">
                <div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>
                <div>
                    <h3 class="text-gray-500 text-sm">تعداد واحدها</h3>
                    <p id="total-units" class="text-2xl font-bold text-yellow-700">0</p>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-4">
                <div class="bg-red-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></div>
                <div>
                    <h3 class="text-gray-500 text-sm">میانگین مصرف</h3>
                    <p id="average-consumption" class="text-2xl font-bold text-red-700">0 m³</p>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="bg-white rounded-xl shadow-sm p-6 hidden">
            <!-- Controls: Search and Export -->
            <div class="mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full md:w-1/3">
                    <input type="text" id="search-input" placeholder="جستجوی نام واحد..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
                        PDF
                    </button>
                    <button id="export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 100 4v2a2 2 0 01-2 2H4a2 2 0 01-2-2v-2a2 2 0 100-4V6z" /></svg>
                        Excel
                    </button>
                </div>
            </div>
            <!-- Main Table -->
            <div class="overflow-x-auto">
                <table class="w-full min-w-max text-center">
                    <thead class="bg-gray-100 border-b-2 border-gray-200">
                        <tr>
                            <th class="p-3 font-semibold text-gray-600 text-sm tracking-wider">نام واحد</th>
                            <th class="p-3 font-semibold text-gray-600 text-sm tracking-wider">قرائت قبلی (m³)</th>
                            <th class="p-3 font-semibold text-gray-600 text-sm tracking-wider">قرائت فعلی (m³)</th>
                            <th class="p-3 font-semibold text-gray-600 text-sm tracking-wider">میزان مصرف (m³)</th>
                            <th class="p-3 font-semibold text-gray-600 text-sm tracking-wider">پله مصرف</th>
                            <th class="p-3 font-semibold text-gray-600 text-sm tracking-wider">هزینه نهایی (تومان)</th>
                        </tr>
                    </thead>
                    <tbody id="main-table-body"></tbody>
                </table>
            </div>
        </div>
         <div id="no-period-selected" class="text-center p-10 bg-white rounded-lg shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <p class="mt-4 text-lg text-gray-500">برای شروع، از دکمه "مدیریت دوره‌ها" یک دوره جدید بسازید یا یک دوره موجود را انتخاب کنید.</p>
        </div>
    </div>

    <!-- Modals -->
    <!-- Periods Modal -->
    <div id="periods-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl transform transition-all scale-95 opacity-0" style="transition: transform 0.3s ease, opacity 0.3s ease;">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-gray-800">مدیریت دوره‌ها</h2>
                <button id="close-periods-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- New Period Form -->
                <div class="border-r-0 md:border-r md:pr-6 border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">ایجاد دوره جدید</h3>
                    <div class="space-y-4">
                        <input type="text" id="new-period-name" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="نام دوره (مثال: بهار ۱۴۰۳)">
                        <input type="text" id="new-period-start-date" data-jdp class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="تاریخ شروع" readonly>
                        <input type="text" id="new-period-end-date" data-jdp class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="تاریخ پایان" readonly>
                        <button id="add-period-btn" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-all flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span>ایجاد دوره</span>
                        </button>
                    </div>
                </div>
                <!-- Periods List -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">لیست دوره‌ها</h3>
                    <div id="periods-list" class="max-h-80 overflow-y-auto pr-2">
                        <p class="text-center text-gray-500">هیچ دوره‌ای یافت نشد.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform transition-all scale-95 opacity-0" style="transition: transform 0.3s ease, opacity 0.3s ease;">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-gray-800">تنظیمات تعرفه پلکانی</h2>
                <button id="close-settings-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p class="text-sm text-gray-500 mb-4">محدوده مصرف را بر حسب متر مکعب (m³) و نرخ را به تومان وارد کنید. برای پلکان آخر، فیلد "تا" را خالی بگذارید.</p>
            <div id="tiers-container" class="space-y-2"></div>
            <button id="add-tier-btn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                افزودن پلکان
            </button>
            <div class="mt-6 flex justify-end gap-4 border-t pt-4">
                <button id="cancel-settings-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition-all">انصراف</button>
                <button id="save-settings-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-all">ذخیره تنظیمات</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center transform transition-all scale-95 opacity-0" style="transition: transform 0.3s ease, opacity 0.3s ease;">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-3" id="confirm-title">حذف دوره</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" id="confirm-message">آیا از حذف این مورد اطمینان دارید؟ این عملیات غیرقابل بازگشت است.</p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="confirm-ok-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:col-start-2 sm:text-sm">
                    حذف
                </button>
                <button id="confirm-cancel-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                    انصراف
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg z-50">
        <p id="toast-message"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let appState = {
                periods: [],
                tiers: [],
                activePeriodId: null
            };

            const unitStructure = [
                { floor: 'طبقه اول', units: Array.from({length: 7}, (_, i) => `واحد ${i + 1}`) },
                { floor: 'طبقه دوم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 8}`) },
                { floor: 'طبقه سوم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 15}`) },
                { floor: 'طبقه چهارم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 22}`) },
                { floor: 'طبقه پنجم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 29}`) },
                { floor: 'طبقه ششم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 36}`) },
                { floor: 'طبقه هفتم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 43}`) },
                { floor: 'طبقه هشتم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 50}`) },
                { floor: 'طبقه نهم', units: Array.from({length: 7}, (_, i) => `واحد ${i + 57}`) },
                { floor: 'همکف', units: ['واحد ۶۴'] },
                { floor: 'مشاعات', units: ['بخش عمومی', 'بخش تجاری'] }
            ];

            // --- DOM ELEMENTS ---
            const DOMElements = {
                mainTableBody: document.getElementById('main-table-body'),
                totalConsumptionEl: document.getElementById('total-consumption'),
                totalCalculatedCostEl: document.getElementById('total-calculated-cost'),
                totalUnitsEl: document.getElementById('total-units'),
                averageConsumptionEl: document.getElementById('average-consumption'),
                currentPeriodTitle: document.getElementById('current-period-title'),
                currentPeriodDates: document.getElementById('current-period-dates'),
                mainContent: document.getElementById('main-content'),
                noPeriodSelected: document.getElementById('no-period-selected'),
                exportPdfBtn: document.getElementById('export-pdf-btn'),
                exportExcelBtn: document.getElementById('export-excel-btn'),
                periodsModal: document.getElementById('periods-modal'),
                settingsModal: document.getElementById('settings-modal'),
                confirmModal: document.getElementById('confirm-modal'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                searchInput: document.getElementById('search-input'),
            };

            // --- UTILITY FUNCTIONS ---
            const showToast = (message, type = 'success') => {
                DOMElements.toastMessage.textContent = message;
                DOMElements.toast.className = `toast fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 show ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                setTimeout(() => {
                    DOMElements.toast.classList.remove('show');
                }, 3000);
            };

            const openModal = (modal) => {
                modal.classList.add('active');
                setTimeout(() => {
                    modal.querySelector('div > div').classList.remove('scale-95', 'opacity-0');
                }, 10);
            };

            const closeModal = (modal) => {
                modal.querySelector('div > div').classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.remove('active');
                }, 300);
            };

            // --- DATA HANDLING ---
            function loadState() {
                appState.periods = JSON.parse(localStorage.getItem('waterBillPeriods_v4')) || [];
                appState.tiers = JSON.parse(localStorage.getItem('waterBillTiers_v4')) || getDefaultTiers();
                appState.activePeriodId = localStorage.getItem('waterBillActivePeriodId_v4') || null;
            }

            function saveState() {
                localStorage.setItem('waterBillPeriods_v4', JSON.stringify(appState.periods));
                localStorage.setItem('waterBillTiers_v4', JSON.stringify(appState.tiers));
                localStorage.setItem('waterBillActivePeriodId_v4', appState.activePeriodId);
            }
            
            function getDefaultTiers() {
                return [
                    { from: 0, to: 7, rate: 1200 },
                    { from: 7, to: 15, rate: 1800 },
                    { from: 15, to: 25, rate: 3000 },
                    { from: 25, to: Infinity, rate: 5000 }
                ];
            }

            // --- CORE LOGIC ---
            function calculateUnitCost(consumption) {
                let cost = 0;
                const sortedTiers = [...appState.tiers].sort((a, b) => a.from - b.from);
                let remainingConsumption = consumption;

                for (const tier of sortedTiers) {
                    if (remainingConsumption <= 0) break;
                    
                    if (consumption > tier.from) {
                        const tierRange = tier.to === Infinity ? remainingConsumption : tier.to - tier.from;
                        const consumptionInTier = Math.min(remainingConsumption, tierRange);
                        if (consumptionInTier > 0) {
                           cost += consumptionInTier * tier.rate;
                           remainingConsumption -= consumptionInTier;
                        }
                    }
                }
                return cost;
            }
            
            function getConsumptionTierName(consumption) {
                if (consumption <= 0) return '-';
                const sortedTiers = [...appState.tiers].sort((a, b) => a.from - b.from);
                for (let i = 0; i < sortedTiers.length; i++) {
                    const tier = sortedTiers[i];
                    if (consumption > tier.from && consumption <= tier.to) {
                        return `پلکان ${i + 1}`;
                    }
                }
                if (consumption > sortedTiers[sortedTiers.length - 1].from) {
                    return `پلکان ${sortedTiers.length}`;
                }
                return '-';
            }

            function calculateAll() {
                const period = appState.periods.find(p => p.id == appState.activePeriodId);
                if (!period) return;

                let totalConsumption = 0;
                let totalCost = 0;
                let unitCount = 0;

                period.readings.forEach(r => {
                    r.consumption = r.currentReading - r.prevReading;
                    if (r.consumption < 0) r.consumption = 0;
                    r.cost = calculateUnitCost(r.consumption);
                    r.tierName = getConsumptionTierName(r.consumption);
                    totalConsumption += r.consumption;
                    totalCost += r.cost;
                    unitCount++;
                });

                DOMElements.totalConsumptionEl.textContent = `${totalConsumption.toFixed(2)} m³`;
                DOMElements.totalCalculatedCostEl.textContent = `${Math.round(totalCost).toLocaleString('fa-IR')} تومان`;
                DOMElements.totalUnitsEl.textContent = unitCount;
                DOMElements.averageConsumptionEl.textContent = unitCount > 0 ? `${(totalConsumption / unitCount).toFixed(2)} m³` : '0 m³';
                
                renderTable();
                saveState();
            }

            // --- RENDERING ---
            function renderTable(filter = '') {
                const period = appState.periods.find(p => p.id == appState.activePeriodId);
                if (!period) return;

                DOMElements.mainTableBody.innerHTML = '';
                const allConsumptions = period.readings.map(r => r.consumption);
                const maxConsumption = Math.max(...allConsumptions, 1);
                const filterText = filter.trim().toLowerCase();

                unitStructure.forEach(floor => {
                    const floorUnits = floor.units.filter(unitName => {
                        const unitReading = period.readings.find(r => r.name === unitName);
                        return unitReading && unitName.toLowerCase().includes(filterText);
                    });

                    if (floorUnits.length === 0) return;

                    const floorHeaderRow = document.createElement('tr');
                    floorHeaderRow.className = 'bg-gray-100 sticky top-0';
                    floorHeaderRow.innerHTML = `<td colspan="6" class="p-2 text-right pr-4 font-bold text-gray-600">${floor.floor}</td>`;
                    DOMElements.mainTableBody.appendChild(floorHeaderRow);

                    floorUnits.forEach(unitName => {
                        const unitReading = period.readings.find(r => r.name === unitName);
                        
                        const ratio = Math.min(unitReading.consumption / (maxConsumption * 0.75), 1);
                        const r = Math.round(239 * ratio + (1 - ratio) * 236);
                        const g = Math.round(68 * ratio + (1 - ratio) * 242);
                        const b = Math.round(68 * ratio + (1 - ratio) * 255);
                        const color = `rgb(${r}, ${g}, ${b})`;

                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';
                        row.style.backgroundColor = color;

                        row.innerHTML = `
                            <td class="p-3 font-medium text-gray-900">${unitReading.name}</td>
                            <td class="p-3"><input type="number" class="w-24 p-1 text-center border rounded-md bg-white" value="${unitReading.prevReading}" data-name="${unitReading.name}" data-field="prevReading"></td>
                            <td class="p-3"><input type="number" class="w-24 p-1 text-center border rounded-md bg-white" value="${unitReading.currentReading}" data-name="${unitReading.name}" data-field="currentReading"></td>
                            <td class="p-3 font-bold">${unitReading.consumption.toFixed(2)}</td>
                            <td class="p-3 text-sm">${unitReading.tierName}</td>
                            <td class="p-3 font-bold text-indigo-700">${Math.round(unitReading.cost).toLocaleString('fa-IR')}</td>
                        `;
                        DOMElements.mainTableBody.appendChild(row);
                    });
                });
            }
            
            function renderActivePeriod() {
                const period = appState.periods.find(p => p.id == appState.activePeriodId);
                if (!period) {
                    showNoPeriodView();
                    return;
                }
                
                DOMElements.mainContent.style.display = 'block';
                DOMElements.noPeriodSelected.style.display = 'none';
                DOMElements.exportPdfBtn.disabled = false;
                DOMElements.exportExcelBtn.disabled = false;
                DOMElements.currentPeriodTitle.textContent = `دوره فعال: ${period.name}`;
                DOMElements.currentPeriodDates.textContent = `از ${period.startDate} تا ${period.endDate}`;
                
                calculateAll();
            }

            function showNoPeriodView() {
                DOMElements.mainContent.style.display = 'none';
                DOMElements.noPeriodSelected.style.display = 'block';
                DOMElements.exportPdfBtn.disabled = true;
                DOMElements.exportExcelBtn.disabled = true;
                DOMElements.currentPeriodTitle.textContent = 'هیچ دوره‌ای انتخاب نشده است';
                DOMElements.currentPeriodDates.textContent = '';
                DOMElements.totalConsumptionEl.textContent = '0 m³';
                DOMElements.totalCalculatedCostEl.textContent = '0 تومان';
                DOMElements.totalUnitsEl.textContent = '0';
                DOMElements.averageConsumptionEl.textContent = '0 m³';
            }

            // --- MODAL LOGIC ---
            function openPeriodsModal() {
                const periodsList = document.getElementById('periods-list');
                periodsList.innerHTML = '';
                if (appState.periods.length === 0) {
                    periodsList.innerHTML = '<p class="text-center text-gray-500">هیچ دوره‌ای ساخته نشده است.</p>';
                } else {
                    [...appState.periods].reverse().forEach(period => {
                        const periodEl = document.createElement('div');
                        periodEl.className = `border-b p-3 flex justify-between items-center hover:bg-gray-50 transition-colors ${period.id == appState.activePeriodId ? 'bg-indigo-50 border-r-4 border-indigo-500' : ''}`;
                        periodEl.innerHTML = `
                            <div>
                                <p class="font-bold text-gray-800">${period.name}</p>
                                <p class="text-sm text-gray-500">${period.startDate} - ${period.endDate}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="bg-blue-500 text-white text-sm py-1 px-3 rounded-md hover:bg-blue-600" data-action="select" data-id="${period.id}">انتخاب</button>
                                <button class="bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600" data-action="delete" data-id="${period.id}">حذف</button>
                            </div>
                        `;
                        periodsList.appendChild(periodEl);
                    });
                }
                openModal(DOMElements.periodsModal);
            }
            
            function openSettingsModal() {
                const tiersContainer = document.getElementById('tiers-container');
                tiersContainer.innerHTML = '';
                appState.tiers.forEach((tier, index) => {
                    const tierEl = document.createElement('div');
                    tierEl.className = 'grid grid-cols-10 gap-2 items-center';
                    tierEl.innerHTML = `
                        <span class="col-span-1 text-sm text-gray-500">از:</span>
                        <input type="number" placeholder="m³" class="col-span-2 p-1 border rounded-md" value="${tier.from}" data-index="${index}" data-field="from">
                        <span class="col-span-1 text-sm text-gray-500">تا:</span>
                        <input type="number" placeholder="m³" class="col-span-2 p-1 border rounded-md" value="${tier.to === Infinity ? '' : tier.to}" data-index="${index}" data-field="to">
                        <span class="col-span-1 text-sm text-gray-500">نرخ:</span>
                        <input type="number" placeholder="تومان" class="col-span-2 p-1 border rounded-md" value="${tier.rate}" data-index="${index}" data-field="rate">
                        <button class="col-span-1 bg-red-500 text-white rounded-md px-2 py-1 hover:bg-red-600" data-index="${index}" data-action="remove-tier">-</button>
                    `;
                    tiersContainer.appendChild(tierEl);
                });
                openModal(DOMElements.settingsModal);
            }

            function showConfirmModal(title, message, onConfirm) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                openModal(DOMElements.confirmModal);

                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');

                const confirmHandler = () => {
                    onConfirm();
                    closeModal(DOMElements.confirmModal);
                    cleanup();
                };

                const cancelHandler = () => {
                    closeModal(DOMElements.confirmModal);
                    cleanup();
                };
                
                const cleanup = () => {
                    okBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                }

                okBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
            }

            // --- EVENT HANDLERS ---
            function attachEventListeners() {
                // Main table input changes
                DOMElements.mainTableBody.addEventListener('input', (e) => {
                    if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                        const period = appState.periods.find(p => p.id == appState.activePeriodId);
                        if (!period) return;
                        
                        const unitName = e.target.dataset.name;
                        const field = e.target.dataset.field;
                        const unitReading = period.readings.find(r => r.name === unitName);

                        if (unitReading) {
                            unitReading[field] = parseFloat(e.target.value) || 0;
                            calculateAll();
                        }
                    }
                });
                
                // Main control buttons
                document.getElementById('manage-periods-btn').addEventListener('click', openPeriodsModal);
                document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
                DOMElements.exportPdfBtn.addEventListener('click', exportToPDF);
                DOMElements.exportExcelBtn.addEventListener('click', exportToExcel);
                DOMElements.searchInput.addEventListener('input', (e) => renderTable(e.target.value));

                // Periods Modal
                document.getElementById('close-periods-btn').addEventListener('click', () => closeModal(DOMElements.periodsModal));
                document.getElementById('add-period-btn').addEventListener('click', () => {
                    const name = document.getElementById('new-period-name').value;
                    const startDate = document.getElementById('new-period-start-date').value;
                    const endDate = document.getElementById('new-period-end-date').value;

                    if (!name || !startDate || !endDate) {
                        showToast("لطفاً تمام فیلدها را پر کنید.", 'error');
                        return;
                    }
                    
                    const newPeriod = {
                        id: Date.now(),
                        name, startDate, endDate,
                        readings: []
                    };

                    const lastPeriod = appState.periods.length > 0 ? appState.periods[appState.periods.length - 1] : null;

                    unitStructure.forEach(floor => {
                        floor.units.forEach(unitName => {
                            const lastUnitReading = lastPeriod ? lastPeriod.readings.find(r => r.name === unitName) : null;
                            const prevReading = lastUnitReading ? lastUnitReading.currentReading : 0;
                            newPeriod.readings.push({
                                name: unitName,
                                prevReading: prevReading,
                                currentReading: prevReading,
                                consumption: 0,
                                tierName: '-',
                                cost: 0
                            });
                        });
                    });

                    appState.periods.push(newPeriod);
                    appState.activePeriodId = newPeriod.id;
                    saveState();
                    renderActivePeriod();
                    openPeriodsModal(); // Refresh list
                    showToast('دوره جدید با موفقیت ایجاد شد.');
                    document.getElementById('new-period-name').value = '';
                    document.getElementById('new-period-start-date').value = '';
                    document.getElementById('new-period-end-date').value = '';
                });

                document.getElementById('periods-list').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    const action = button.dataset.action;
                    const id = button.dataset.id;

                    if (action === 'select') {
                        appState.activePeriodId = id;
                        saveState();
                        renderActivePeriod();
                        closeModal(DOMElements.periodsModal);
                    } else if (action === 'delete') {
                        showConfirmModal('حذف دوره', 'آیا از حذف این دوره مطمئن هستید؟', () => {
                            appState.periods = appState.periods.filter(p => p.id != id);
                            if (appState.activePeriodId == id) {
                                appState.activePeriodId = appState.periods.length > 0 ? appState.periods[appState.periods.length - 1].id : null;
                                renderActivePeriod();
                            }
                            saveState();
                            openPeriodsModal();
                            showToast('دوره با موفقیت حذف شد.', 'success');
                        });
                    }
                });

                // Settings Modal
                document.getElementById('close-settings-btn').addEventListener('click', () => closeModal(DOMElements.settingsModal));
                document.getElementById('cancel-settings-btn').addEventListener('click', () => closeModal(DOMElements.settingsModal));
                document.getElementById('add-tier-btn').addEventListener('click', () => {
                    const lastTier = appState.tiers.length > 0 ? appState.tiers[appState.tiers.length - 1] : { to: 0 };
                    appState.tiers.push({ from: lastTier.to, to: Infinity, rate: 0 });
                    openSettingsModal();
                });

                document.getElementById('tiers-container').addEventListener('click', (e) => {
                    if (e.target.dataset.action === 'remove-tier') {
                        appState.tiers.splice(e.target.dataset.index, 1);
                        openSettingsModal();
                    }
                });

                document.getElementById('save-settings-btn').addEventListener('click', () => {
                    const newTiers = [];
                    document.querySelectorAll('#tiers-container > div').forEach(tierEl => {
                        const from = parseFloat(tierEl.querySelector('[data-field="from"]').value) || 0;
                        let to = parseFloat(tierEl.querySelector('[data-field="to"]').value);
                        if (isNaN(to) || to === 0) to = Infinity;
                        const rate = parseFloat(tierEl.querySelector('[data-field="rate"]').value) || 0;
                        newTiers.push({ from, to, rate });
                    });
                    appState.tiers = newTiers;
                    if (appState.activePeriodId) calculateAll();
                    else saveState();
                    closeModal(DOMElements.settingsModal);
                    showToast('تنظیمات با موفقیت ذخیره شد.');
                });
            }
            
            // --- EXPORT FUNCTIONS ---
            function exportToPDF() {
                const period = appState.periods.find(p => p.id == appState.activePeriodId);
                if (!period) return;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // This is a placeholder for a base64 encoded Vazir font. 
                // For a real application, you'd need to generate this from a .ttf file.
                const vazirFontBase64 = 'AAEAAAARAQAABAAQR0RFRgQsBBMAAAE4AAAAHkdQT1O5VIX/AAAEyAAAAGxHU1VCv1L+qgAABRAAAABYQlBLVGFyAAAA/AAAAD5PUy8y+jtoLgAAAVgAAABgY21hcCAA9/MAAAGYAAABUmdhc3AAAAAQAAAEwAAAAAhnbHlmwsmuegAAAagAAADwaGVhZBNu2dsAAAEcAAAANmhoZWEH3gOFAAABPAAAACRobXR4DAAAAAAAAbAAAAAQbG9jYQAKADIAAAGQAAAADG1heHABGgBuAAABKAAAACBuYW1lRchzIAAABJAAAAIxcG9zdL4o/lUAABwAAAAAvgABAAAAAQAA1YG9y18PPPUACwQAAAAAANiVn+IAAAAA2JWf4gAAAAAD3/MAAAAAAAQAAgAAAAAAAAABAAAEAAAAAAAAAAQAAUAAAAAEAIAAAAEAAAAAywAAAEsAAwABAAAALAADAAoAAQAgA5AABAAQAAAACgAIAAIAAgAgA5AAT//f//AAAAAAAgA5AA3//v//8AAAAAAQAEAAUACAADAAQABQAGAAcACAAJAAoACwAMAA0ABgACAAAAAAoAfgADAAEECQAAADYAAAADAAEECQABACgANAADAAEECQACAA4ANgADAAEECQADADgAQgADAAEECQAEADgAUgADAAEECQAFABYAYgADAAEECQAGACYAcgADAAEECQAIADgA2gADAAEECQAKADAA+gADAAEECQALAEAA/gADAAEECQAMAEgBBAADAAEECQANADgBGAADAAEECQAAAAgAFAAcAFAAaACgAKgAsAC4AMAAyADgAOgA8AD4AQgBEAEgASgBMAE4AUABSAFQAVgBYAFoAXABeAGIAZABoAGoAbABuAHAAdAB2AHgAegB8AIAAggCEAIYAjACSAJQAlgCYAJoAnACiAKQAqgCsALoAwADMANAA2ADgAOgA8AD4AQQBDAEUARwBJAEsATQBPAGIBkgAAABQAFAA4AFAAcACAAIgAkACYAQIBigGKAQIBiwGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigGKAQIBigG-';

                doc.addFileToVFS("Vazirmatn-Regular.ttf", vazirFontBase64);
                doc.addFont("Vazirmatn-Regular.ttf", "Vazirmatn", "normal");
                doc.setFont("Vazirmatn");

                const head = [[ 'هزینه نهایی (تومان)', 'پله مصرف', 'مصرف (m³)', 'قرائت فعلی', 'قرائت قبلی', 'نام واحد' ]];
                const body = period.readings.map(r => [
                    Math.round(r.cost).toLocaleString('fa-IR'),
                    r.tierName,
                    r.consumption.toFixed(2),
                    r.currentReading,
                    r.prevReading,
                    r.name
                ]);

                const title = `گزارش آب بها برای: ${period.name}`;
                const dates = `از ${period.startDate} تا ${period.endDate}`;
                doc.text(title, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.text(dates, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });

                doc.autoTable({
                    head: head, body: body, startY: 30,
                    styles: { font: "Vazirmatn", halign: 'center', fontSize: 9 },
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    columnStyles: { 5: { halign: 'right' } }
                });
                
                doc.save(`گزارش-آب-بها-${period.name.replace(/[\s/]/g, '-')}.pdf`);
            }
            
            function exportToExcel() {
                const period = appState.periods.find(p => p.id == appState.activePeriodId);
                if (!period) return;

                const worksheetData = period.readings.map(r => ({
                    "نام واحد": r.name,
                    "قرائت قبلی": r.prevReading,
                    "قرائت فعلی": r.currentReading,
                    "میزان مصرف (m³)": r.consumption,
                    "پله مصرف": r.tierName,
                    "هزینه نهایی (تومان)": r.cost
                }));
                const worksheet = XLSX.utils.json_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, period.name);
                
                XLSX.writeFile(workbook, `داده-های-آب-بها-${period.name.replace(/[\s/]/g, '-')}.xlsx`);
            }
            
            // --- INITIALIZATION ---
            function initializeApp() {
                loadState();
                attachEventListeners();
                jalaliDatepicker.startWatch({
                    selector: '[data-jdp]',
                    time: false,
                    persianDigits: true,
                });
                if (appState.activePeriodId) {
                    renderActivePeriod();
                } else {
                    showNoPeriodView();
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>
