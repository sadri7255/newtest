<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم محاسبه قبض آب ساختمان</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --low-consumption: #4caf50;
            --medium-consumption: #ff9800;
            --high-consumption: #f44336;
            --zero-consumption: #f44336;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Vazir', 'Segoe UI', Tahoma, sans-serif;
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .consumption-cell {
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .consumption-0 {
            background-color: var(--zero-consumption);
            color: white;
        }
        
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #0d6efd;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border: none;
        }
        
        .card-header {
            background-color: #f1f8ff;
            font-weight: bold;
            padding: 10px 15px;
            font-size: 0.95rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .tier-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .color-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .unit-row input, .unit-row select {
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
        }
        
        .form-label {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 0.3rem 0.5rem;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        .tier-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .tier-row > div {
            margin-left: 10px;
        }
        
        .summary-row {
            background-color: #e9ecef;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
            
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .tier-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .tier-row > div {
                margin-left: 0;
                margin-top: 5px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="fas fa-tint me-2"></i>سیستم محاسبه قبض آب ساختمان</h1>
            <p class="mb-0">محاسبه دقیق و منصفانه هزینه آب مصرفی واحدها</p>
        </div>

        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                    <i class="fas fa-home me-1"></i> محاسبه قبض
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">
                    <i class="fas fa-cog me-1"></i> تنظیمات
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                    <i class="fas fa-history me-1"></i> تاریخچه
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- تب محاسبه قبض -->
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>اطلاعات دوره جاری</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="resetForm">
                                        <i class="fas fa-redo me-1"></i> شروع جدید
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="periodName" class="form-label">نام دوره</label>
                                        <input type="text" class="form-control" id="periodName" placeholder="مثال: بهار 1402">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="billDate" class="form-label">تاریخ قرائت</label>
                                        <input type="text" class="form-control" id="billDate" placeholder="1402/03/15">
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="consumptionTable">
                                        <thead class="table-light">
                                            <tr class="summary-row">
                                                <th colspan="5" class="text-center">جمع کل</th>
                                                <th id="totalConsumption">0</th>
                                                <th></th>
                                                <th id="totalCost">0</th>
                                            </tr>
                                            <tr>
                                                <th width="10%">طبقه</th>
                                                <th width="5%">#</th>
                                                <th width="20%">نام واحد</th>
                                                <th width="15%">قرائت قبلی</th>
                                                <th width="15%">قرائت فعلی</th>
                                                <th width="15%">مصرف (متر مکعب)</th>
                                                <th width="10%">پلکان</th>
                                                <th width="20%">هزینه (تومان)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- ردیف ها توسط جاوااسکریپت اضافه خواهند شد -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3 flex-wrap">
                                    <div class="mb-2">
                                        <button class="btn btn-success btn-sm" id="calculateBtn">
                                            <i class="fas fa-calculator me-1"></i> محاسبه
                                        </button>
                                        <button class="btn btn-primary btn-sm ms-2" id="saveBtn">
                                            <i class="fas fa-save me-1"></i> ذخیره دوره
                                        </button>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-danger btn-sm" id="exportPdf">
                                            <i class="fas fa-file-pdf me-1"></i> PDF
                                        </button>
                                        <button class="btn btn-outline-success btn-sm ms-1" id="exportExcel">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm ms-1" id="importExcel">
                                            <i class="fas fa-file-import me-1"></i> Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- تب تنظیمات -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">تنظیمات پلکان مصرف</div>
                            <div class="card-body">
                                <div class="alert alert-info py-2">
                                    <i class="fas fa-info-circle me-1"></i> پلکان‌های مصرف را به ترتیب از کم به زیاد تعریف کنید.
                                </div>
                                
                                <div class="mb-2">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label class="form-label">حداکثر مصرف</label>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">قیمت هر واحد (تومان)</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="tierSettings">
                                    <div class="tier-row">
                                        <span class="fw-bold">پلکان 1</span>
                                        <div>
                                            <input type="number" class="form-control form-control-sm tier-max" value="10">
                                        </div>
                                        <div>
                                            <input type="number" class="form-control form-control-sm tier-price" value="5000">
                                        </div>
                                        <button class="btn btn-sm btn-danger remove-tier align-self-end">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="tier-row">
                                        <span class="fw-bold">پلکان 2</span>
                                        <div>
                                            <input type="number" class="form-control form-control-sm tier-max" value="20">
                                        </div>
                                        <div>
                                            <input type="number" class="form-control form-control-sm tier-price" value="8000">
                                        </div>
                                        <button class="btn btn-sm btn-danger remove-tier align-self-end">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <button class="btn btn-sm btn-outline-primary mt-2" id="addTier">
                                    <i class="fas fa-plus me-1"></i> افزودن پلکان
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">تنظیمات عمومی</div>
                            <div class="card-body">
                                <div class="mb-2 form-check">
                                    <input type="checkbox" class="form-check-input" id="autoTransfer">
                                    <label class="form-check-label" for="autoTransfer">انتقال خودکار قرائت فعلی به قبلی برای دوره بعد</label>
                                </div>
                                
                                <button class="btn btn-primary btn-sm" id="saveSettings">
                                    <i class="fas fa-save me-1"></i> ذخیره تنظیمات
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- تب تاریخچه -->
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>تاریخچه دوره‌های قبلی</span>
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" class="form-control form-control-sm" placeholder="جستجو در تاریخچه..." id="historySearch">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>نام دوره</th>
                                        <th>تاریخ قرائت</th>
                                        <th>مصرف کل</th>
                                        <th>مبلغ کل</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable">
                                    <tr>
                                        <td colspan="5" class="text-center">هیچ داده‌ای وجود ندارد</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // داده‌های نمونه برای نمایش
        const sampleData = {
            units: [],
            tiers: [
                { max: 10, price: 5000 },
                { max: 20, price: 8000 },
                { max: 30, price: 12000 },
                { max: Infinity, price: 20000 }
            ],
            history: [
                { period: "زمستان 1401", date: "1401/12/15", totalConsumption: 1250, totalCost: 12500000 },
                { period: "پاییز 1401", date: "1401/09/10", totalConsumption: 980, totalCost: 9800000 },
                { period: "تابستان 1401", date: "1401/06/05", totalConsumption: 2150, totalCost: 21500000 }
            ]
        };

        // ایجاد 64 واحد به صورت خودکار با طبقات
        for (let floor = 1; floor <= 9; floor++) {
            for (let unit = 1; unit <= 7; unit++) {
                const unitNumber = (floor - 1) * 7 + unit;
                if (unitNumber <= 64) {
                    sampleData.units.push({
                        id: unitNumber,
                        name: `واحد ${unitNumber}`,
                        floor: floor,
                        type: "مسکونی",
                        previousReading: Math.floor(Math.random() * 100),
                        currentReading: Math.floor(Math.random() * 100) + 100
                    });
                }
            }
        }

        // اضافه کردن واحد همکف
        sampleData.units.push({
            id: 64,
            name: "واحد 64",
            floor: "همکف",
            type: "مسکونی",
            previousReading: Math.floor(Math.random() * 100),
            currentReading: Math.floor(Math.random() * 100) + 100
        });

        // اضافه کردن واحدهای عمومی و تجاری
        sampleData.units.push({
            id: 65,
            name: "عمومی",
            floor: "-",
            type: "عمومی",
            previousReading: 150,
            currentReading: 180
        });

        sampleData.units.push({
            id: 66,
            name: "تجاری 1",
            floor: "-",
            type: "تجاری",
            previousReading: 220,
            currentReading: 280
        });

        // توابع اصلی برنامه
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // رویدادهای دکمه‌ها
            document.getElementById('calculateBtn').addEventListener('click', calculateCosts);
            document.getElementById('saveBtn').addEventListener('click', savePeriod);
            document.getElementById('exportPdf').addEventListener('click', exportToPdf);
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('importExcel').addEventListener('click', importFromExcel);
            document.getElementById('resetForm').addEventListener('click', resetForm);
            document.getElementById('addTier').addEventListener('click', addTier);
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // اضافه کردن رویداد حذف برای پلکان‌های موجود
            document.querySelectorAll('.remove-tier').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.tier-row').remove();
                    updateTierNumbers();
                });
            });
            
            // بارگذاری اولیه داده‌ها
            loadSampleData();
            renderHistoryTable();
        });

        // به روزرسانی شماره پلکان‌ها
        function updateTierNumbers() {
            const tierRows = document.querySelectorAll('.tier-row');
            tierRows.forEach((row, index) => {
                row.querySelector('.fw-bold').textContent = `پلکان ${index + 1}`;
            });
        }

        // مقداردهی اولیه برنامه
        function initializeApp() {
            // ایجاد واحدها
            sampleData.units.forEach(unit => {
                addUnitToTable(unit);
            });
            
            // محاسبه اولیه
            calculateCosts();
        }

        // اضافه کردن واحد به جدول
        function addUnitToTable(unitData) {
            const tbody = document.querySelector('#consumptionTable tbody');
            const row = document.createElement('tr');
            row.className = 'unit-row';
            
            row.innerHTML = `
                <td>${unitData.floor}</td>
                <td>${unitData.id}</td>
                <td><input type="text" class="form-control form-control-sm" value="${unitData.name}"></td>
                <td><input type="number" class="form-control form-control-sm previous-reading" value="${unitData.previousReading}"></td>
                <td><input type="number" class="form-control form-control-sm current-reading" value="${unitData.currentReading}"></td>
                <td class="consumption-cell">0</td>
                <td class="tier-cell">-</td>
                <td class="cost-cell">0</td>
            `;
            
            tbody.appendChild(row);
            
            // اضافه کردن رویداد تغییر قرائت
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', calculateCosts);
            });
        }

        // محاسبه هزینه‌ها
        function calculateCosts() {
            const rows = document.querySelectorAll('#consumptionTable tbody tr');
            let totalConsumption = 0;
            let totalCost = 0;
            
            // به روزرسانی پلکان‌ها از تنظیمات
            updateTiersFromSettings();
            
            rows.forEach(row => {
                const previous = parseFloat(row.querySelector('.previous-reading').value) || 0;
                const current = parseFloat(row.querySelector('.current-reading').value) || 0;
                const consumption = current - previous;
                
                const consumptionCell = row.querySelector('.consumption-cell');
                consumptionCell.textContent = consumption;
                
                // اعمال رنگ‌بندی بر اساس میزان مصرف
                consumptionCell.classList.remove('consumption-0');
                if (consumption === 0) {
                    consumptionCell.classList.add('consumption-0');
                } else {
                    // برای نمایش طیف رنگی از سبز به نارنجی (مصرف کم سبز، مصرف زیاد نارنجی)
                    const intensity = Math.min(consumption / 50, 1);
                    const red = Math.floor(76 + 179 * intensity);
                    const green = Math.floor(175 * (1 - intensity));
                    const blue = Math.floor(80 * (1 - intensity));
                    consumptionCell.style.backgroundColor = `rgb(${red}, ${green}, ${blue})`;
                    consumptionCell.style.color = intensity > 0.7 ? 'white' : 'black';
                }
                
                // تعیین پلکان مصرف
                let tier = 0;
                for (let i = 0; i < sampleData.tiers.length; i++) {
                    if (consumption <= sampleData.tiers[i].max) {
                        tier = i + 1;
                        break;
                    }
                }
                
                const tierCell = row.querySelector('.tier-cell');
                tierCell.textContent = tier;
                
                // محاسبه هزینه بر اساس پلکان
                let cost = 0;
                let remainingConsumption = consumption;
                
                for (let i = 0; i < sampleData.tiers.length; i++) {
                    if (remainingConsumption <= 0) break;
                    
                    const tierMax = sampleData.tiers[i].max;
                    const tierPrice = sampleData.tiers[i].price;
                    
                    if (i === sampleData.tiers.length - 1 || remainingConsumption <= tierMax) {
                        cost += remainingConsumption * tierPrice;
                        break;
                    } else {
                        cost += tierMax * tierPrice;
                        remainingConsumption -= tierMax;
                    }
                }
                
                const costCell = row.querySelector('.cost-cell');
                costCell.textContent = cost.toLocaleString();
                
                totalConsumption += consumption;
                totalCost += cost;
            });
            
            // نمایش مجموع
            document.getElementById('totalConsumption').textContent = totalConsumption.toLocaleString();
            document.getElementById('totalCost').textContent = totalCost.toLocaleString();
        }

        // به روزرسانی پلکان‌ها از تنظیمات
        function updateTiersFromSettings() {
            const tierItems = document.querySelectorAll('.tier-row');
            sampleData.tiers = [];
            
            tierItems.forEach(item => {
                const max = parseInt(item.querySelector('.tier-max').value);
                const price = parseInt(item.querySelector('.tier-price').value);
                sampleData.tiers.push({ max, price });
            });
        }

        // بارگذاری داده‌های نمونه
        function loadSampleData() {
            document.getElementById('periodName').value = 'تابستان 1402';
            document.getElementById('billDate').value = '1402/06/15';
        }

        // بازنشانی فرم
        function resetForm() {
            if (confirm('آیا از پاک کردن تمام داده‌های جاری اطمینان دارید؟')) {
                const tbody = document.querySelector('#consumptionTable tbody');
                tbody.innerHTML = '';
                
                document.getElementById('periodName').value = '';
                document.getElementById('billDate').value = '';
                
                initializeApp();
            }
        }

        // ذخیره دوره جاری
        function savePeriod() {
            const periodName = document.getElementById('periodName').value || 'دوره بدون نام';
            const billDate = document.getElementById('billDate').value || 'تاریخ نامشخص';
            
            // محاسبه مصرف کل
            const totalConsumption = parseInt(document.getElementById('totalConsumption').textContent.replace(/,/g, ''));
            const totalCost = parseInt(document.getElementById('totalCost').textContent.replace(/,/g, ''));
            
            // اضافه کردن به تاریخچه
            sampleData.history.unshift({
                period: periodName,
                date: billDate,
                totalConsumption: totalConsumption,
                totalCost: totalCost
            });
            
            // به روزرسانی نمایش تاریخچه
            renderHistoryTable();
            
            // نمایش پیام موفقیت
            alert(`دوره "${periodName}" با موفقیت ذخیره شد.`);
        }

        // افزودن پلکان جدید
        function addTier() {
            const container = document.getElementById('tierSettings');
            const tierCount = container.children.length;
            
            const tierElement = document.createElement('div');
            tierElement.className = 'tier-row';
            tierElement.innerHTML = `
                <span class="fw-bold">پلکان ${tierCount + 1}</span>
                <div>
                    <input type="number" class="form-control form-control-sm tier-max" value="${(tierCount + 1) * 15}">
                </div>
                <div>
                    <input type="number" class="form-control form-control-sm tier-price" value="${(tierCount + 1) * 6000}">
                </div>
                <button class="btn btn-sm btn-danger remove-tier align-self-end">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            container.appendChild(tierElement);
            
            // اضافه کردن رویداد حذف پلکان
            tierElement.querySelector('.remove-tier').addEventListener('click', function() {
                tierElement.remove();
                updateTierNumbers();
            });
        }

        // ذخیره تنظیمات
        function saveSettings() {
            // ذخیره پلکان‌ها
            updateTiersFromSettings();
            
            // ذخیره تنظیمات انتقال خودکار
            const autoTransfer = document.getElementById('autoTransfer').checked;
            
            alert('تنظیمات با موفقیت ذخیره شد.');
        }

        // نمایش تاریخچه
        function renderHistoryTable() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            
            if (sampleData.history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">هیچ داده‌ای وجود ندارد</td></tr>';
                return;
            }
            
            sampleData.history.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.period}</td>
                    <td>${item.date}</td>
                    <td>${item.totalConsumption.toLocaleString()}</td>
                    <td>${item.totalCost.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-history" data-period="${item.period}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-1 download-history" data-period="${item.period}">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // اضافه کردن رویداد مشاهده تاریخچه
            document.querySelectorAll('.view-history').forEach(button => {
                button.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');
                    alert(`مشاهده تاریخچه دوره: ${period}`);
                });
            });
            
            // اضافه کردن رویداد دانلود تاریخچه
            document.querySelectorAll('.download-history').forEach(button => {
                button.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');
                    alert(`دانلود تاریخچه دوره: ${period}`);
                });
            });
        }

        // خروجی PDF
        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // عنوان
            doc.setFontSize(18);
            doc.text('گزارش قبض آب ساختمان', 105, 15, { align: 'center' });
            
            // اطلاعات دوره
            doc.setFontSize(12);
            doc.text(`نام دوره: ${document.getElementById('periodName').value}`, 20, 25);
            doc.text(`تاریخ قرائت: ${document.getElementById('billDate').value}`, 20, 35);
            
            // داده‌های جدول
            const rows = [];
            const header = ['طبقه', 'ردیف', 'نام واحد', 'قرائت قبلی', 'قرائت فعلی', 'مصرف', 'پلکان', 'هزینه'];
            rows.push(header);
            
            document.querySelectorAll('#consumptionTable tbody tr').forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].querySelector('input').value,
                    cells[3].querySelector('input').value,
                    cells[4].querySelector('input').value,
                    cells[5].textContent,
                    cells[6].textContent,
                    cells[7].textContent
                ];
                rows.push(rowData);
            });
            
            // ایجاد جدول در PDF
            doc.autoTable({
                startY: 55,
                head: [rows[0]],
                body: rows.slice(1),
                styles: { font: 'vazir', fontStyle: 'normal' },
                headStyles: { fillColor: [41, 128, 185], textColor: 255 }
            });
            
            // ذخیره فایل
            const periodName = document.getElementById('periodName').value || 'report';
            doc.save(`گزارش_قبض_آب_${periodName}.pdf`);
        }

        // خروجی Excel
        function exportToExcel() {
            // ایجاد workbook جدید
            const wb = XLSX.utils.book_new();
            
            // ایجاد داده‌های جدول
            const data = [];
            
            // عنوان و اطلاعات دوره
            data.push(['گزارش قبض آب ساختمان']);
            data.push([]);
            data.push(['نام دوره:', document.getElementById('periodName').value]);
            data.push(['تاریخ قرائت:', document.getElementById('billDate').value]);
            data.push([]);
            
            // هدر جدول
            const header = ['طبقه', 'ردیف', 'نام واحد', 'قرائت قبلی', 'قرائت فعلی', 'مصرف (متر مکعب)', 'پلکان', 'هزینه (تومان)'];
            data.push(header);
            
            // داده‌های واحدها
            document.querySelectorAll('#consumptionTable tbody tr').forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                data.push([
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].querySelector('input').value,
                    cells[3].querySelector('input').value,
                    cells[4].querySelector('input').value,
                    cells[5].textContent,
                    cells[6].textContent,
                    cells[7].textContent
                ]);
            });
            
            // اضافه کردن جمع کل
            data.push([]);
            data.push(['جمع کل', '', '', '', '', 
                document.getElementById('totalConsumption').textContent,
                '',
                document.getElementById('totalCost').textContent]);
            
            // ایجاد worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // اضافه کردن worksheet به workbook
            XLSX.utils.book_append_sheet(wb, ws, 'گزارش قبض آب');
            
            // تولید فایل Excel و دانلود
            const periodName = document.getElementById('periodName').value || 'report';
            XLSX.writeFile(wb, `گزارش_قبض_آب_${periodName}.xlsx`);
        }

        // ورودی Excel
        function importFromExcel() {
            // ایجاد یک input فایل پنهان
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx, .xls';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // گرفتن اولین worksheet
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // تبدیل به JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    alert(`فایل Excel با ${jsonData.length} ردیف بارگیری شد.`);
                    // در اینجا می‌توانید داده‌ها را پردازش کرده و به جدول اضافه کنید
                };
                
                reader.readAsArrayBuffer(file);
            };
            
            fileInput.click();
        }
    </script>
</body>
</html>